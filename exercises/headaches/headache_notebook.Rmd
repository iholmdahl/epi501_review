---
title: "EPI 501: Headache exercise (annotated)"
output: html_notebook
---

## Introduction

This is annotated code for the headache exercise (i.e., modeling non-infectious diseases). If you're familiar with `R` and prefer to use the raw `R` code, check out [`'headache_exercise.R'`](./headache_exercise.R)

## Setting up

Always remember to load `deSolve` at the top of your code. If running the following code gives you an error, you likely need to install `deSolve`. You can do so by running: `install.packages("deSolve")`. This package contains the `ode()` function we will use to solve our model. 

```{r}
## EPI 501: Differential equations of headaches (or non-infectious diseases)

## Load deSolve
library(deSolve)
```

## Prepping your model

Every model will three inputs:

1. A sequence of time steps (`times`)
1. Initial values (`yinit`)
1. A vector of named parameters and their values (`parameters`)

```{r}
## Set your time steps, initial values, parameters
times <- seq(0, 5000, by = 1)
yinit <- c(no_headache = 0.95, headache = 0.05)
parameters <- c(incidence = 0.02, recovery = 0.01, 
                birth = 0.1, death = 0.2)
```

## Create your ODE model

Every ODE model will need to be written as a function. Don't worry --- we will always give you the boilerplate code for this. 

Below, the `dno_headache` and `dheadache` variables represent your compartments. 

```{r}
## Create an ODE model -- the solver needs your model written as a function
## that takes in a vector of times, initial values, and parameters 
## (in that order) and returns a list with derivatives of your compartments 
## relative to time.
headache_model <- function(times, yinit, parameters) {
    with(as.list(c(yinit, parameters)), {
        
        ## Define your no headache compartment
        dno_headache <- recovery*headache - 
            incidence*no_headache - death*no_headache 
        
        ## Define your headache compartment
        dheadache <- incidence*no_headache - recovery*headache - 
            death*headache + birth*(headache+no_headache)
        
        ## Don't forget you need to return your compartments
        return(list(c(dno_headache, dheadache)))
    })
}
```

## Running your model
Once you've set up your model, you'll use `ode()` to solve the differential equations. The `as.data.frame()` function just converts the output of `ode()` (a matrix) into a `data.frame` for easier manipulation.

```{r}
## Run your model
result <- as.data.frame(ode(y = yinit, times = times, 
                            func = headache_model, parms = parameters))
```

## Plotting the results

We can quickly plot our results using a function called `matplot()`. This function takes several inputs---try `help(matplot)` to read a bit of help---and is designed for plotting one column of a matrix on the x-axis against multiple columns of the same matrix on the y-axis.

Below, I specify that our x-axis should be the `time` column of the matrix `x`. The empty space before the comma just means I want all rows. (Note, you could also use `result[, 1]`). I also specify the two columns (`no_headache` and `headache`).

```{r}
matplot(x = result[, "time"], 
        y = result[, c("no_headache", "headache")], 
        type = "l")
```

It's hard to tell what is happening here because our model has reached equilibrium quickly. We can specify another parameter, `xlim` which will limit the x-axis. Let's try limiting the x-axis to be values between 0 and 100.

```{r}
matplot(x = result[, "time"], 
        y = result[, c("no_headache", "headache")], 
        type = "l", 
        xlim = c(0, 100))
```

Now we see that after about 60 time steps, both those with headaches and those without headaches reaches 0. Why?